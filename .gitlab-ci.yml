---
stages:
  - decision


decision:
  artifacts:
    expire_in: 1 year
    paths:
      - artifacts/*
  # TODO Port jobgraph to Python 3.10
  image: python:3.9-alpine@sha256:eb1b2038f12c8916be54329319a625de2dfec4266b718efdb798cc149b342a2f
  retry:
    max: 2
    when:
      - unknown_failure
      - stale_schedule
      - runner_system_failure
      - stuck_or_timeout_failure
  script:
    - apk update && apk add --no-cache --update git
    - pip install --require-hashes --requirement "$CI_PROJECT_DIR/requirements/base.txt"
    - python "$CI_PROJECT_DIR/setup.py" install
    - >-
      if [[ -n $CI_MERGE_REQUEST_SOURCE_PROJECT_URL ]]; then
        export BASE_REPOSITORY="$CI_MERGE_REQUEST_SOURCE_PROJECT_URL"
      else
        export BASE_REPOSITORY="$CI_REPOSITORY_URL"
      fi
    - >-
      jobgraph decision
      --base-repository="$BASE_REPOSITORY"
      --head-ref="$CI_COMMIT_BRANCH"
      --head-repository="$CI_REPOSITORY_URL"
      --head-rev="$CI_COMMIT_SHA"
      --head-tag="$CI_COMMIT_TAG"
      --level='1'
      --message="$CI_COMMIT_MESSAGE"
      --owner="$CI_COMMIT_AUTHOR"
      --pipeline-source="$CI_PIPELINE_SOURCE"
      --project='jobgraph'
      --pushdate='0'
  stage: decision
